



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.14">
    
    
      
        <title>Cite Filter - manubot</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.d3202873.min.css">
      
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ff0a5ce4.min.css">
      
      
        
        
        <meta name="theme-color" content="#4cae4f">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="green" data-md-color-accent="lightgreen">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-manubotpandoccite_filter" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../../../.." title="manubot" class="md-header-nav__button md-logo" aria-label="manubot">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            manubot
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Cite Filter
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/manubot/manubot/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    manubot
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="manubot" class="md-nav__button md-logo" aria-label="manubot">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    manubot
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/manubot/manubot/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    manubot
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../LICENSE/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Reference
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Reference" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1" checked>
    
    <label class="md-nav__link" for="nav-3-1">
      Manubot
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Manubot" data-md-level="2">
      <label class="md-nav__title" for="nav-3-1">
        <span class="md-nav__icon md-icon"></span>
        Manubot
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../command/" title="Command" class="md-nav__link">
      Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../util/" title="Util" class="md-nav__link">
      Util
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-4" type="checkbox" id="nav-3-1-4">
    
    <label class="md-nav__link" for="nav-3-1-4">
      Cite
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Cite" data-md-level="3">
      <label class="md-nav__title" for="nav-3-1-4">
        <span class="md-nav__icon md-icon"></span>
        Cite
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/arxiv/" title="Arxiv" class="md-nav__link">
      Arxiv
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/citations/" title="Citations" class="md-nav__link">
      Citations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/cite_command/" title="Cite Command" class="md-nav__link">
      Cite Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/citekey/" title="Citekey" class="md-nav__link">
      Citekey
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/citeproc/" title="Citeproc" class="md-nav__link">
      Citeproc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/csl_item/" title="Csl Item" class="md-nav__link">
      Csl Item
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/curie/" title="Curie" class="md-nav__link">
      Curie
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/doi/" title="Doi" class="md-nav__link">
      Doi
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/handlers/" title="Handlers" class="md-nav__link">
      Handlers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/isbn/" title="Isbn" class="md-nav__link">
      Isbn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/pubmed/" title="Pubmed" class="md-nav__link">
      Pubmed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/unpaywall/" title="Unpaywall" class="md-nav__link">
      Unpaywall
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/url/" title="Url" class="md-nav__link">
      Url
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/wikidata/" title="Wikidata" class="md-nav__link">
      Wikidata
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/zotero/" title="Zotero" class="md-nav__link">
      Zotero
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-4-17" type="checkbox" id="nav-3-1-4-17">
    
    <label class="md-nav__link" for="nav-3-1-4-17">
      Tests
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Tests" data-md-level="4">
      <label class="md-nav__title" for="nav-3-1-4-17">
        <span class="md-nav__icon md-icon"></span>
        Tests
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_arxiv/" title="Test Arxiv" class="md-nav__link">
      Test Arxiv
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_citations/" title="Test Citations" class="md-nav__link">
      Test Citations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_cite_command/" title="Test Cite Command" class="md-nav__link">
      Test Cite Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_citekey/" title="Test Citekey" class="md-nav__link">
      Test Citekey
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_citekey_api/" title="Test Citekey Api" class="md-nav__link">
      Test Citekey Api
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_citeproc/" title="Test Citeproc" class="md-nav__link">
      Test Citeproc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_csl_item/" title="Test Csl Item" class="md-nav__link">
      Test Csl Item
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_curie/" title="Test Curie" class="md-nav__link">
      Test Curie
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_doi/" title="Test Doi" class="md-nav__link">
      Test Doi
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_handlers/" title="Test Handlers" class="md-nav__link">
      Test Handlers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_isbn/" title="Test Isbn" class="md-nav__link">
      Test Isbn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_pubmed/" title="Test Pubmed" class="md-nav__link">
      Test Pubmed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_unpaywall/" title="Test Unpaywall" class="md-nav__link">
      Test Unpaywall
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_url/" title="Test Url" class="md-nav__link">
      Test Url
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_wikidata/" title="Test Wikidata" class="md-nav__link">
      Test Wikidata
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_zotero/" title="Test Zotero" class="md-nav__link">
      Test Zotero
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-5" type="checkbox" id="nav-3-1-5" checked>
    
    <label class="md-nav__link" for="nav-3-1-5">
      Pandoc
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Pandoc" data-md-level="3">
      <label class="md-nav__title" for="nav-3-1-5">
        <span class="md-nav__icon md-icon"></span>
        Pandoc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../bibliography/" title="Bibliography" class="md-nav__link">
      Bibliography
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Cite Filter
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" title="Cite Filter" class="md-nav__link md-nav__link--active">
      Cite Filter
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#options" class="md-nav__link">
    Options
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#development-commands" class="md-nav__link">
    development commands
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#main" class="md-nav__link">
    main
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parse_args" class="md-nav__link">
    parse_args
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#process_citations" class="md-nav__link">
    process_citations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../util/" title="Util" class="md-nav__link">
      Util
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-6" type="checkbox" id="nav-3-1-6">
    
    <label class="md-nav__link" for="nav-3-1-6">
      Process
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Process" data-md-level="3">
      <label class="md-nav__title" for="nav-3-1-6">
        <span class="md-nav__icon md-icon"></span>
        Process
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/bibliography/" title="Bibliography" class="md-nav__link">
      Bibliography
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/ci/" title="Ci" class="md-nav__link">
      Ci
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/manuscript/" title="Manuscript" class="md-nav__link">
      Manuscript
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/metadata/" title="Metadata" class="md-nav__link">
      Metadata
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/process_command/" title="Process Command" class="md-nav__link">
      Process Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/requests_cache/" title="Requests Cache" class="md-nav__link">
      Requests Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/util/" title="Util" class="md-nav__link">
      Util
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-6-9" type="checkbox" id="nav-3-1-6-9">
    
    <label class="md-nav__link" for="nav-3-1-6-9">
      Tests
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Tests" data-md-level="4">
      <label class="md-nav__title" for="nav-3-1-6-9">
        <span class="md-nav__icon md-icon"></span>
        Tests
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/tests/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/tests/test_bibliography/" title="Test Bibliography" class="md-nav__link">
      Test Bibliography
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/tests/test_ci/" title="Test Ci" class="md-nav__link">
      Test Ci
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/tests/test_metadata/" title="Test Metadata" class="md-nav__link">
      Test Metadata
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/tests/test_process_command/" title="Test Process Command" class="md-nav__link">
      Test Process Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/tests/test_util/" title="Test Util" class="md-nav__link">
      Test Util
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-7" type="checkbox" id="nav-3-1-7">
    
    <label class="md-nav__link" for="nav-3-1-7">
      Tests
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Tests" data-md-level="3">
      <label class="md-nav__title" for="nav-3-1-7">
        <span class="md-nav__icon md-icon"></span>
        Tests
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../tests/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tests/test_command/" title="Test Command" class="md-nav__link">
      Test Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tests/test_imports/" title="Test Imports" class="md-nav__link">
      Test Imports
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tests/test_readme/" title="Test Readme" class="md-nav__link">
      Test Readme
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tests/test_util/" title="Test Util" class="md-nav__link">
      Test Util
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-8" type="checkbox" id="nav-3-1-8">
    
    <label class="md-nav__link" for="nav-3-1-8">
      Webpage
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Webpage" data-md-level="3">
      <label class="md-nav__title" for="nav-3-1-8">
        <span class="md-nav__icon md-icon"></span>
        Webpage
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../webpage/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../webpage/webpage_command/" title="Webpage Command" class="md-nav__link">
      Webpage Command
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#options" class="md-nav__link">
    Options
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#development-commands" class="md-nav__link">
    development commands
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#main" class="md-nav__link">
    main
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parse_args" class="md-nav__link">
    parse_args
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#process_citations" class="md-nav__link">
    process_citations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/manubot/manubot/edit/master/reference/manubot/pandoc/cite_filter.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="module-manubotpandoccite_filter">Module manubot.pandoc.cite_filter</h1>
<p>This module defines a pandoc filter for manubot cite functionality.
The filter can be called with the <code>pandoc-manubot-cite</code> command.</p>
<h2 id="options">Options</h2>
<p>Configuration is provided via Pandoc metadata fields.</p>
<ul>
<li>
<p><code>bibliography</code> (sequence of strings):
  Use to define reference metadata manually.
  Pandoc supports specifying multiple external bibliography files.
  When bibliography files are specified,
  this filter will read them instead of pandoc.
  Behavior should be similar to Pandoc,
  with format inferred by extension:
  .json for CSL JSON,
  .yaml for CSL YAML,
  .bib for BibLaTeX.</p>
</li>
<li>
<p><code>references</code> (sequence of CSL-Item mappings):
  Same as Pandoc's references metadata field.</p>
</li>
<li>
<p><code>citekey-aliases</code> (mapping: string -&gt; string):
  Used to define aliases (tags) for cite-by-id citations.
  Useful when a citation is used many times or contains invalid characters.
  Aliases can also be defined in markdown with link reference syntax.</p>
</li>
<li>
<p><code>manubot-output-citekeys</code> (string):
  path to write TSV table of citekeys
  showing their transformation from input_id to short_id.</p>
</li>
<li>
<p><code>manubot-bibliography-cache</code> (string):
  Path to read and write bibliographic metadata as CSL JSON/YAML.
  Intended as a human-editable cache of the bibliography data,
  for situations where this filter is run multiple times.
  This is similar to specifying bibliography=FILE and manubot-output-bibliography=FILE in a single argument,
  but will not error trying to read a bibliography file that does not yet exist.</p>
</li>
<li>
<p><code>manubot-output-bibliography</code> (string):
  path to write generated CSL JSON bibliography.
  If specified in addition to <code>manubot-bibliography-cache</code>,
  two output bibliographies will be written (with the same references).</p>
</li>
<li>
<p><code>manubot-requests-cache-path</code> (string):
  Enable caching HTTP requests to this path (minus the extension) using <a href="https://github.com/reclosedev/requests-cache">requests-cache</a>.
  For example, setting to <code>.cache/requests-cache</code> will cache requests to <code>.cache/requests-cache.sqlite</code>.</p>
</li>
<li>
<p><code>manubot-clear-requests-cache</code> (boolean):
  If true, clear the requests cache at <code>manubot-requests-cache-path</code>.</p>
</li>
</ul>
<h2 id="development-commands">development commands</h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># export to plain text (with pandoc &lt; 2.11)</span>
pandoc   --to<span class="o">=</span>plain   --standalone   --filter<span class="o">=</span>pandoc-manubot-cite   --filter<span class="o">=</span>pandoc-citeproc   manubot/pandoc/tests/test_cite_filter/input.md

<span class="c1"># call the filter manually using pandoc JSON output</span>
pandoc   --to<span class="o">=</span>json   manubot/pandoc/tests/test_cite_filter/input.md   <span class="p">|</span> python manubot/pandoc/test_cite.py markdown
</code></pre></div>

<p>Related resources on pandoc filters:</p>
<ul>
<li><a href="https://github.com/jgm/pandocfilters">python pandocfilters package</a></li>
<li><a href="https://github.com/sergiocorreia/panflute">python panflute package</a></li>
<li><a href="http://scorreia.com/software/panflute/code.html#panflute.elements.Citation">panflute Citation class</a></li>
</ul>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">This module defines a pandoc filter for manubot cite functionality.</span>

<span class="sd">The filter can be called with the `pandoc-manubot-cite` command.</span>

<span class="sd">## Options</span>

<span class="sd">Configuration is provided via Pandoc metadata fields.</span>

<span class="sd">- `bibliography` (sequence of strings):</span>

<span class="sd">  Use to define reference metadata manually.</span>

<span class="sd">  Pandoc supports specifying multiple external bibliography files.</span>

<span class="sd">  When bibliography files are specified,</span>

<span class="sd">  this filter will read them instead of pandoc.</span>

<span class="sd">  Behavior should be similar to Pandoc,</span>

<span class="sd">  with format inferred by extension:</span>

<span class="sd">  .json for CSL JSON,</span>

<span class="sd">  .yaml for CSL YAML,</span>

<span class="sd">  .bib for BibLaTeX.</span>

<span class="sd">- `references` (sequence of CSL-Item mappings):</span>

<span class="sd">  Same as Pandoc&#39;s references metadata field.</span>

<span class="sd">- `citekey-aliases` (mapping: string -&gt; string):</span>

<span class="sd">  Used to define aliases (tags) for cite-by-id citations.</span>

<span class="sd">  Useful when a citation is used many times or contains invalid characters.</span>

<span class="sd">  Aliases can also be defined in markdown with link reference syntax.</span>

<span class="sd">- `manubot-output-citekeys` (string):</span>

<span class="sd">  path to write TSV table of citekeys</span>

<span class="sd">  showing their transformation from input_id to short_id.</span>

<span class="sd">- `manubot-bibliography-cache` (string):</span>

<span class="sd">  Path to read and write bibliographic metadata as CSL JSON/YAML.</span>

<span class="sd">  Intended as a human-editable cache of the bibliography data,</span>

<span class="sd">  for situations where this filter is run multiple times.</span>

<span class="sd">  This is similar to specifying bibliography=FILE and manubot-output-bibliography=FILE in a single argument,</span>

<span class="sd">  but will not error trying to read a bibliography file that does not yet exist.</span>

<span class="sd">- `manubot-output-bibliography` (string):</span>

<span class="sd">  path to write generated CSL JSON bibliography.</span>

<span class="sd">  If specified in addition to `manubot-bibliography-cache`,</span>

<span class="sd">  two output bibliographies will be written (with the same references).</span>

<span class="sd">- `manubot-requests-cache-path` (string):</span>

<span class="sd">  Enable caching HTTP requests to this path (minus the extension) using [requests-cache](https://github.com/reclosedev/requests-cache).</span>

<span class="sd">  For example, setting to `.cache/requests-cache` will cache requests to `.cache/requests-cache.sqlite`.</span>

<span class="sd">- `manubot-clear-requests-cache` (boolean):</span>

<span class="sd">  If true, clear the requests cache at `manubot-requests-cache-path`.</span>

<span class="sd">## development commands</span>

<span class="sd">```shell</span>

<span class="sd"># export to plain text (with pandoc &lt; 2.11)</span>

<span class="sd">pandoc \</span>

<span class="sd">  --to=plain \</span>

<span class="sd">  --standalone \</span>

<span class="sd">  --filter=pandoc-manubot-cite \</span>

<span class="sd">  --filter=pandoc-citeproc \</span>

<span class="sd">  manubot/pandoc/tests/test_cite_filter/input.md</span>

<span class="sd"># call the filter manually using pandoc JSON output</span>

<span class="sd">pandoc \</span>

<span class="sd">  --to=json \</span>

<span class="sd">  manubot/pandoc/tests/test_cite_filter/input.md \</span>

<span class="sd">  | python manubot/pandoc/test_cite.py markdown</span>

<span class="sd">```</span>

<span class="sd">Related resources on pandoc filters:</span>

<span class="sd">- [python pandocfilters package](https://github.com/jgm/pandocfilters)</span>

<span class="sd">- [python panflute package](https://github.com/sergiocorreia/panflute)</span>

<span class="sd">- [panflute Citation class](http://scorreia.com/software/panflute/code.html#panflute.elements.Citation)</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="n">import</span> <span class="n">argparse</span>

<span class="n">import</span> <span class="n">logging</span>

<span class="n">import</span> <span class="n">os</span>

<span class="n">from</span> <span class="n">typing</span> <span class="n">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>

<span class="n">import</span> <span class="n">panflute</span> <span class="k">as</span> <span class="n">pf</span>

<span class="n">from</span> <span class="n">manubot</span><span class="o">.</span><span class="n">cite</span><span class="o">.</span><span class="n">citations</span> <span class="n">import</span> <span class="n">Citations</span>

<span class="n">def</span> <span class="n">parse_args</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Read command line arguments</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>

        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Pandoc filter for citation by persistent identifier. &quot;</span>

        <span class="s2">&quot;Filters are command-line programs that read and write a JSON-encoded abstract syntax tree for Pandoc. &quot;</span>

        <span class="s2">&quot;Unless you are debugging, run this filter as part of a pandoc command by specifying --filter=pandoc-manubot-cite.&quot;</span>

    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>

        <span class="s2">&quot;target_format&quot;</span><span class="p">,</span>

        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;output format of the pandoc command, as per Pandoc&#39;s --to option&quot;</span><span class="p">,</span>

    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>

        <span class="s2">&quot;--input&quot;</span><span class="p">,</span>

        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span>

        <span class="n">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span>

        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path read JSON input (defaults to stdin)&quot;</span><span class="p">,</span>

    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>

        <span class="s2">&quot;--output&quot;</span><span class="p">,</span>

        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span>

        <span class="n">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span>

        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to write JSON output (defaults to stdout)&quot;</span><span class="p">,</span>

    <span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">args</span>

<span class="n">def</span> <span class="n">_get_citekeys_action</span><span class="p">(</span><span class="n">elem</span><span class="p">:</span> <span class="n">pf</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span> <span class="n">doc</span><span class="p">:</span> <span class="n">pf</span><span class="o">.</span><span class="n">Doc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Panflute action to extract citationId from all Citations in the AST.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">pf</span><span class="o">.</span><span class="n">Citation</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">None</span>

    <span class="n">manuscript_citekeys</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">manubot</span><span class="p">[</span><span class="s2">&quot;manuscript_citekeys&quot;</span><span class="p">]</span>

    <span class="n">manuscript_citekeys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">None</span>

<span class="n">def</span> <span class="n">_citation_to_id_action</span><span class="p">(</span><span class="n">elem</span><span class="p">:</span> <span class="n">pf</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span> <span class="n">doc</span><span class="p">:</span> <span class="n">pf</span><span class="o">.</span><span class="n">Doc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Panflute action to update the citationId of Citations in the AST</span>

<span class="sd">    with their manubot-created keys.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">pf</span><span class="o">.</span><span class="n">Citation</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">None</span>

    <span class="n">mapper</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">manubot</span><span class="p">[</span><span class="s2">&quot;citekey_shortener&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">mapper</span><span class="p">:</span>

        <span class="n">elem</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">None</span>

<span class="n">def</span> <span class="n">_get_reference_link_citekey_aliases</span><span class="p">(</span><span class="n">elem</span><span class="p">:</span> <span class="n">pf</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span> <span class="n">doc</span><span class="p">:</span> <span class="n">pf</span><span class="o">.</span><span class="n">Doc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Extract citekey aliases from the document that were defined</span>

<span class="sd">    using markdown&#39;s link reference syntax.</span>

<span class="sd">    https://spec.commonmark.org/0.29/#link-reference-definitions</span>

<span class="sd">    Based on pandoc-url2cite implementation by phiresky at</span>

<span class="sd">    https://github.com/phiresky/pandoc-url2cite/blob/b28374a9a037a5ce1747b8567160d8dffd64177e/index.ts#L118-L152</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">type</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pf</span><span class="o">.</span><span class="n">Para</span><span class="p">:</span>

        <span class="c1"># require link reference definitions to be in their own paragraph</span>

        <span class="k">return</span>

    <span class="k">while</span> <span class="p">(</span>

        <span class="n">len</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span>

        <span class="ow">and</span> <span class="n">type</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">pf</span><span class="o">.</span><span class="n">Cite</span>

        <span class="ow">and</span> <span class="n">len</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">citations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="ow">and</span> <span class="n">type</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">pf</span><span class="o">.</span><span class="n">Str</span>

        <span class="ow">and</span> <span class="n">elem</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s2">&quot;:&quot;</span>

    <span class="p">):</span>

        <span class="c1"># paragraph consists of at least a Cite (with one Citation),</span>

        <span class="c1"># a Str (equal to &quot;:&quot;), and additional elements, such as a</span>

        <span class="c1"># link destination and possibly more link-reference definitions.</span>

        <span class="n">space_index</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">type</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="n">pf</span><span class="o">.</span><span class="n">Space</span> <span class="k">else</span> <span class="mi">2</span>

        <span class="n">destination</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="n">space_index</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">type</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span> <span class="o">==</span> <span class="n">pf</span><span class="o">.</span><span class="n">Str</span><span class="p">:</span>

            <span class="c1"># paragraph starts with `[@something]: something`</span>

            <span class="c1"># save info to citekeys and remove from paragraph</span>

            <span class="n">citekey</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">citations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>

            <span class="n">citekey_aliases</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">manubot</span><span class="p">[</span><span class="s2">&quot;citekey_aliases&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span>

                <span class="n">citekey</span> <span class="ow">in</span> <span class="n">citekey_aliases</span>

                <span class="ow">and</span> <span class="n">citekey_aliases</span><span class="p">[</span><span class="n">citekey</span><span class="p">]</span> <span class="o">!=</span> <span class="n">destination</span><span class="o">.</span><span class="n">text</span>

            <span class="p">):</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;multiple aliases defined for @{citekey}&quot;</span><span class="p">)</span>

            <span class="n">citekey_aliases</span><span class="p">[</span><span class="n">citekey</span><span class="p">]</span> <span class="o">=</span> <span class="n">destination</span><span class="o">.</span><span class="n">text</span>

            <span class="c1"># found citation, add it to citekeys and remove it from document</span>

            <span class="n">elem</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="n">space_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>

        <span class="c1"># remove leading SoftBreak, before continuing</span>

        <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">type</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">pf</span><span class="o">.</span><span class="n">SoftBreak</span><span class="p">:</span>

            <span class="n">elem</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">def</span> <span class="n">_get_load_manual_references_kwargs</span><span class="p">(</span><span class="n">doc</span><span class="p">:</span> <span class="n">pf</span><span class="o">.</span><span class="n">Doc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Return keyword arguments for Citations.load_manual_references.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">manual_refs</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;references&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>

    <span class="n">bibliography_paths</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;bibliography&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">bibliography_paths</span><span class="p">,</span> <span class="n">list</span><span class="p">):</span>

        <span class="n">bibliography_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">bibliography_paths</span><span class="p">]</span>

    <span class="n">bibliography_cache_path</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">manubot</span><span class="p">[</span><span class="s2">&quot;bibliography_cache&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span>

        <span class="n">bibliography_cache_path</span>

        <span class="ow">and</span> <span class="n">bibliography_cache_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bibliography_paths</span>

        <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bibliography_cache_path</span><span class="p">)</span>

    <span class="p">):</span>

        <span class="n">bibliography_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bibliography_cache_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dict</span><span class="p">(</span>

        <span class="n">paths</span><span class="o">=</span><span class="n">bibliography_paths</span><span class="p">,</span>

        <span class="n">extra_csl_items</span><span class="o">=</span><span class="n">manual_refs</span><span class="p">,</span>

    <span class="p">)</span>

<span class="n">def</span> <span class="n">process_citations</span><span class="p">(</span><span class="n">doc</span><span class="p">:</span> <span class="n">pf</span><span class="o">.</span><span class="n">Doc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Apply citation-by-identifier to a Python object representation of</span>

<span class="sd">    Pandoc&#39;s Abstract Syntax Tree.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># process metadata.manubot-bibliography-cache</span>

    <span class="n">bib_cache</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;manubot-bibliography-cache&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bib_cache</span> <span class="k">is</span> <span class="n">None</span> <span class="ow">or</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">bib_cache</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>

            <span class="n">f</span><span class="s2">&quot;Expected metadata.manubot-bibliography-cache to be a string or null (None), &quot;</span>

            <span class="n">f</span><span class="s2">&quot;but received a {bib_cache.__class__.__name__}. Setting to None.&quot;</span>

        <span class="p">)</span>

        <span class="n">bib_cache</span> <span class="o">=</span> <span class="n">None</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">manubot</span><span class="p">[</span><span class="s2">&quot;bibliography_cache&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bib_cache</span>

    <span class="c1"># process metadata.citekey-aliases</span>

    <span class="n">citekey_aliases</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;citekey-aliases&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">{})</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">citekey_aliases</span><span class="p">,</span> <span class="n">dict</span><span class="p">):</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>

            <span class="n">f</span><span class="s2">&quot;Expected metadata.citekey-aliases to be a dict, &quot;</span>

            <span class="n">f</span><span class="s2">&quot;but received a {citekey_aliases.__class__.__name__}. Disregarding.&quot;</span>

        <span class="p">)</span>

        <span class="n">citekey_aliases</span> <span class="o">=</span> <span class="n">dict</span><span class="p">()</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">manubot</span><span class="p">[</span><span class="s2">&quot;citekey_aliases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">citekey_aliases</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">_get_reference_link_citekey_aliases</span><span class="p">)</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">_get_citekeys_action</span><span class="p">)</span>

    <span class="n">manuscript_citekeys</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">manubot</span><span class="p">[</span><span class="s2">&quot;manuscript_citekeys&quot;</span><span class="p">]</span>

    <span class="n">citations</span> <span class="o">=</span> <span class="n">Citations</span><span class="p">(</span><span class="n">input_ids</span><span class="o">=</span><span class="n">manuscript_citekeys</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="n">citekey_aliases</span><span class="p">)</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">csl_item_failure_log_level</span> <span class="o">=</span> <span class="s2">&quot;ERROR&quot;</span>

    <span class="n">requests_cache_path</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;manubot-requests-cache-path&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">requests_cache_path</span><span class="p">:</span>

        <span class="n">from</span> <span class="n">manubot</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">requests_cache</span> <span class="n">import</span> <span class="n">RequestsCache</span>

        <span class="n">req_cache</span> <span class="o">=</span> <span class="n">RequestsCache</span><span class="p">(</span><span class="n">requests_cache_path</span><span class="p">)</span>

        <span class="n">req_cache</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

        <span class="n">req_cache</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;manubot-clear-requests-cache&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">False</span><span class="p">):</span>

            <span class="n">req_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">filter_pandoc_xnos</span><span class="p">()</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">load_manual_references</span><span class="p">(</span><span class="o">**</span><span class="n">_get_load_manual_references_kwargs</span><span class="p">(</span><span class="n">doc</span><span class="p">))</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">get_csl_items</span><span class="p">()</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">manubot</span><span class="p">[</span><span class="s2">&quot;citekey_shortener&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">citations</span><span class="o">.</span><span class="n">input_to_csl_id</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">_citation_to_id_action</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">requests_cache_path</span><span class="p">:</span>

        <span class="n">req_cache</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">write_citekeys_tsv</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;manubot-output-citekeys&quot;</span><span class="p">))</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">write_csl_items</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;manubot-output-bibliography&quot;</span><span class="p">))</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">write_csl_items</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">manubot</span><span class="p">[</span><span class="s2">&quot;bibliography_cache&quot;</span><span class="p">])</span>

    <span class="c1"># Update pandoc metadata with fields that this filter</span>

    <span class="c1"># has either consumed, created, or modified.</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;bibliography&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">citations</span><span class="o">.</span><span class="n">csl_items</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;citekey_aliases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">citekey_aliases</span>

<span class="n">def</span> <span class="n">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">None</span><span class="p">:</span>

    <span class="n">from</span> <span class="n">manubot</span><span class="o">.</span><span class="n">command</span> <span class="n">import</span> <span class="n">exit_if_error_handler_fired</span><span class="p">,</span> <span class="n">setup_logging_and_errors</span>

    <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">setup_logging_and_errors</span><span class="p">()</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Let panflute handle io to sys.stdout / sys.stdin to set utf-8 encoding.</span>

    <span class="c1"># args.input=None for stdin, args.output=None for stdout</span>

    <span class="n">doc</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">input_stream</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>

    <span class="n">log_level</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;manubot-log-level&quot;</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>

    <span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;logger&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">log_level</span><span class="p">))</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">manubot</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;manuscript_citekeys&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="n">process_citations</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>

    <span class="n">pf</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">output_stream</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;manubot-fail-on-errors&quot;</span><span class="p">,</span> <span class="n">False</span><span class="p">):</span>

        <span class="n">exit_if_error_handler_fired</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;error_handler&quot;</span><span class="p">])</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

</details>
<h2 id="functions">Functions</h2>
<h3 id="main">main</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">(</span>

<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>

    <span class="kn">from</span> <span class="nn">manubot.command</span> <span class="kn">import</span> <span class="n">exit_if_error_handler_fired</span><span class="p">,</span> <span class="n">setup_logging_and_errors</span>

    <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">setup_logging_and_errors</span><span class="p">()</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Let panflute handle io to sys.stdout / sys.stdin to set utf-8 encoding.</span>

    <span class="c1"># args.input=None for stdin, args.output=None for stdout</span>

    <span class="n">doc</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">input_stream</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>

    <span class="n">log_level</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;manubot-log-level&quot;</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>

    <span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;logger&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">log_level</span><span class="p">))</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">manubot</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;manuscript_citekeys&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="n">process_citations</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>

    <span class="n">pf</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">output_stream</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;manubot-fail-on-errors&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>

        <span class="n">exit_if_error_handler_fired</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;error_handler&quot;</span><span class="p">])</span>
</code></pre></div>

</details>
<h3 id="parse_args">parse_args</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">parse_args</span><span class="p">(</span>

<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span>
</code></pre></div>

<p>Read command line arguments</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">parse_args</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="p">.</span><span class="n">Namespace</span><span class="p">:</span>

    <span class="ss">&quot;&quot;&quot;</span>

<span class="ss">    Read command line arguments</span>

<span class="ss">    &quot;&quot;&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span>

        <span class="n">description</span><span class="o">=</span><span class="ss">&quot;Pandoc filter for citation by persistent identifier. &quot;</span>

        <span class="ss">&quot;Filters are command-line programs that read and write a JSON-encoded abstract syntax tree for Pandoc. &quot;</span>

        <span class="ss">&quot;Unless you are debugging, run this filter as part of a pandoc command by specifying --filter=pandoc-manubot-cite.&quot;</span>

    <span class="p">)</span>

    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span>

        <span class="ss">&quot;target_format&quot;</span><span class="p">,</span>

        <span class="n">help</span><span class="o">=</span><span class="ss">&quot;output format of the pandoc command, as per Pandoc&#39;s --to option&quot;</span><span class="p">,</span>

    <span class="p">)</span>

    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span>

        <span class="ss">&quot;--input&quot;</span><span class="p">,</span>

        <span class="n">nargs</span><span class="o">=</span><span class="ss">&quot;?&quot;</span><span class="p">,</span>

        <span class="k">type</span><span class="o">=</span><span class="n">argparse</span><span class="p">.</span><span class="n">FileType</span><span class="p">(</span><span class="ss">&quot;r&quot;</span><span class="p">,</span> <span class="k">encoding</span><span class="o">=</span><span class="ss">&quot;utf-8&quot;</span><span class="p">),</span>

        <span class="n">help</span><span class="o">=</span><span class="ss">&quot;path read JSON input (defaults to stdin)&quot;</span><span class="p">,</span>

    <span class="p">)</span>

    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span>

        <span class="ss">&quot;--output&quot;</span><span class="p">,</span>

        <span class="n">nargs</span><span class="o">=</span><span class="ss">&quot;?&quot;</span><span class="p">,</span>

        <span class="k">type</span><span class="o">=</span><span class="n">argparse</span><span class="p">.</span><span class="n">FileType</span><span class="p">(</span><span class="ss">&quot;w&quot;</span><span class="p">,</span> <span class="k">encoding</span><span class="o">=</span><span class="ss">&quot;utf-8&quot;</span><span class="p">),</span>

        <span class="n">help</span><span class="o">=</span><span class="ss">&quot;path to write JSON output (defaults to stdout)&quot;</span><span class="p">,</span>

    <span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">args</span>
</code></pre></div>

</details>
<h3 id="process_citations">process_citations</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">process_citations</span><span class="p">(</span>
    <span class="n">doc</span><span class="p">:</span> <span class="n">panflute</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">Doc</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<p>Apply citation-by-identifier to a Python object representation of
Pandoc's Abstract Syntax Tree.</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">process_citations</span><span class="p">(</span><span class="n">doc</span><span class="p">:</span> <span class="n">pf</span><span class="o">.</span><span class="n">Doc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Apply citation-by-identifier to a Python object representation of</span>

<span class="sd">    Pandoc&#39;s Abstract Syntax Tree.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># process metadata.manubot-bibliography-cache</span>

    <span class="n">bib_cache</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;manubot-bibliography-cache&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bib_cache</span> <span class="k">is</span> <span class="n">None</span> <span class="ow">or</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">bib_cache</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>

            <span class="n">f</span><span class="s2">&quot;Expected metadata.manubot-bibliography-cache to be a string or null (None), &quot;</span>

            <span class="n">f</span><span class="s2">&quot;but received a {bib_cache.__class__.__name__}. Setting to None.&quot;</span>

        <span class="p">)</span>

        <span class="n">bib_cache</span> <span class="o">=</span> <span class="n">None</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">manubot</span><span class="p">[</span><span class="s2">&quot;bibliography_cache&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bib_cache</span>

    <span class="c1"># process metadata.citekey-aliases</span>

    <span class="n">citekey_aliases</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;citekey-aliases&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">{})</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">citekey_aliases</span><span class="p">,</span> <span class="n">dict</span><span class="p">):</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>

            <span class="n">f</span><span class="s2">&quot;Expected metadata.citekey-aliases to be a dict, &quot;</span>

            <span class="n">f</span><span class="s2">&quot;but received a {citekey_aliases.__class__.__name__}. Disregarding.&quot;</span>

        <span class="p">)</span>

        <span class="n">citekey_aliases</span> <span class="o">=</span> <span class="n">dict</span><span class="p">()</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">manubot</span><span class="p">[</span><span class="s2">&quot;citekey_aliases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">citekey_aliases</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">_get_reference_link_citekey_aliases</span><span class="p">)</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">_get_citekeys_action</span><span class="p">)</span>

    <span class="n">manuscript_citekeys</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">manubot</span><span class="p">[</span><span class="s2">&quot;manuscript_citekeys&quot;</span><span class="p">]</span>

    <span class="n">citations</span> <span class="o">=</span> <span class="n">Citations</span><span class="p">(</span><span class="n">input_ids</span><span class="o">=</span><span class="n">manuscript_citekeys</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="n">citekey_aliases</span><span class="p">)</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">csl_item_failure_log_level</span> <span class="o">=</span> <span class="s2">&quot;ERROR&quot;</span>

    <span class="n">requests_cache_path</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;manubot-requests-cache-path&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">requests_cache_path</span><span class="p">:</span>

        <span class="n">from</span> <span class="n">manubot</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">requests_cache</span> <span class="n">import</span> <span class="n">RequestsCache</span>

        <span class="n">req_cache</span> <span class="o">=</span> <span class="n">RequestsCache</span><span class="p">(</span><span class="n">requests_cache_path</span><span class="p">)</span>

        <span class="n">req_cache</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

        <span class="n">req_cache</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;manubot-clear-requests-cache&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">False</span><span class="p">):</span>

            <span class="n">req_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">filter_pandoc_xnos</span><span class="p">()</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">load_manual_references</span><span class="p">(</span><span class="o">**</span><span class="n">_get_load_manual_references_kwargs</span><span class="p">(</span><span class="n">doc</span><span class="p">))</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">get_csl_items</span><span class="p">()</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">manubot</span><span class="p">[</span><span class="s2">&quot;citekey_shortener&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">citations</span><span class="o">.</span><span class="n">input_to_csl_id</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">_citation_to_id_action</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">requests_cache_path</span><span class="p">:</span>

        <span class="n">req_cache</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">write_citekeys_tsv</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;manubot-output-citekeys&quot;</span><span class="p">))</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">write_csl_items</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;manubot-output-bibliography&quot;</span><span class="p">))</span>

    <span class="n">citations</span><span class="o">.</span><span class="n">write_csl_items</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">manubot</span><span class="p">[</span><span class="s2">&quot;bibliography_cache&quot;</span><span class="p">])</span>

    <span class="c1"># Update pandoc metadata with fields that this filter</span>

    <span class="c1"># has either consumed, created, or modified.</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;bibliography&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">citations</span><span class="o">.</span><span class="n">csl_items</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;citekey_aliases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">citekey_aliases</span>
</code></pre></div>

</details>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../bibliography/" title="Bibliography" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Bibliography
              </span>
            </div>
          </a>
        
        
          <a href="../" title="Index" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Index
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Powered by
        <a href="http://timothycrosley.github.io/portray">portray.</a>
        You too can
        <a href="http://timothycrosley.github.io/portray">
          portray</a>
        your Python project well using automatic documentation.
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/vendor.2d1db4bd.min.js"></script>
      <script src="../../../../assets/javascripts/bundle.6627ddf3.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../../../..",
          features: [],
          search: Object.assign({
            worker: "../../../../assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>